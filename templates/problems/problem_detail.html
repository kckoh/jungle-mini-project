{% extends 'base.html' %} {% block title %}알고리즘 상세{% endblock %} {% block
content %}
<div class="max-w-5xl mx-auto px-0">
    <!-- 상단 헤더 -->
    <div class="pt-2 pb-4 mx-1">
        <div class="flex items-start justify-between gap-3">
            <div>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight">
                    {{ item.title or '알고리즘 제목' }}
                </h1>
                <p class="text-xs text-gray-500 mt-1">
                    {{ item.created_at or '방금 전' }}
                </p>
            </div>
            <a
                href="/problems"
                class="hidden md:inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-200 text-sm hover:bg-gray-50"
            >
                목록
            </a>
        </div>
    </div>

    <!-- 간단 설명 -->
    <div class="mt-2 mb-6 mx-1">{{ item.description or '알고리즘 내용' }}</div>

    <!-- 키워드 섹션 -->
    <div class="border border-gray-200 rounded-xl bg-white overflow-hidden">
        <div class="px-4 md:px-6 py-4 border-b border-gray-200">
            <div class="flex flex-wrap gap-2">
                {% for k, v in keyword_solution.items() %}
                <button
                    class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full border border-gray-200"
                    data-value="{{ v }}"
                    onclick="showKeywordValue(this)"
                >
                    {{ k }}
                </button>
                {% endfor %}
            </div>
            <div
                id="keyword-value-display"
                class="mt-2 text-sm text-gray-600 whitespace-pre-wrap"
            ></div>
        </div>
    </div>

    <!-- 본문 2-컬럼 -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 좌측: 접근방식 (수정/저장 기능 유지) -->
        <section
            class="bg-white border border-gray-200 rounded-xl p-4 md:p-6 shadow-sm hover:shadow-md transition-colors relative"
        >
            <button
                type="button"
                id="approach-edit-btn"
                class="absolute top-3 right-3 inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-50"
                onclick="toggleApproachEdit()"
            >
                ✏️ 수정
            </button>

            <h3 class="font-semibold">접근방식</h3>

            <!-- 보기 모드 -->
            <p id="approach-view" class="pr-16 text-sm text-gray-700 mt-2 mb-2">
                {{ item.approach }}
            </p>

            <!-- 수정 모드 -->
            <div id="approach-edit" class="hidden space-y-2">
                <textarea
                    id="approach-input"
                    class="w-full h-32 rounded-md border border-gray-300 p-2 text-sm"
                >
{{- item.approach | trim -}}</textarea
                >
                <div class="flex gap-2">
                    <button
                        type="button"
                        class="text-xs text-blue-600"
                        onclick="saveApproach()"
                    >
                        💾 저장
                    </button>
                    <button
                        type="button"
                        class="text-xs text-gray-500"
                        onclick="cancelApproachEdit()"
                    >
                        취소
                    </button>
                </div>
            </div>
        </section>

        <!-- 우측: AI 조언 -->
        <section
            class="bg-white border border-gray-200 rounded-xl p-4 md:p-6 shadow-sm hover:shadow-md transition-colors"
        >
            <h3 class="font-semibold">AI 조언</h3>
            {% set ai = item.aiSuggestion %} {% if ai is string and ai|trim in
            ["리뷰 중", "리뷰중"] %}
            <div
                class="mt-2 inline-flex items-center gap-1 px-3 py-1.5 rounded-full bg-red-100 text-red-700 text-sm font-semibold shadow-sm"
            >
                <svg
                    class="w-4 h-4 text-red-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                >
                    <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-4.75a.75.75 0 001.5 0v-1.5a.75.75 0 00-1.5 0v1.5zM10 7a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0v-2.5A.75.75 0 0110 7z"
                        clip-rule="evenodd"
                    />
                </svg>
                리뷰 중
            </div>
            {% elif ai is sequence and ai is not string %}
            <ul class="mt-2 list-disc pl-5 space-y-1 text-sm text-gray-700">
                {% for suggestion in ai %}
                <li>{{ suggestion }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="mt-2 text-sm text-gray-500">AI 조언이 아직 없습니다.</p>
            {% endif %}
        </section>
    </div>
</div>

<!-- Jinja 데이터 주입 -->
<script id="item-data" type="application/json">
    {{ item | tojson }}
</script>

<script>
    // 키워드 표시 토글
    let currentEl = null;
    function showKeywordValue(el) {
        const display = document.getElementById("keyword-value-display");
        const raw = el.getAttribute("data-value");
        let value = raw;

        // JSON으로 직렬화된 문자열일 수 있으므로 한번 파싱 시도
        try {
            value = JSON.parse(raw);
        } catch (_) {
            // 파싱 실패 시 그대로 사용
        }

        if (currentEl === el) {
            display.textContent = "";
            el.classList.remove("bg-gray-100", "border-gray-300");
            currentEl = null;
            return;
        }

        if (currentEl) {
            currentEl.classList.remove("bg-gray-100", "border-gray-300");
        }
        el.classList.add("bg-gray-100", "border-gray-300");

        display.textContent =
            typeof value === "string" ? value : JSON.stringify(value, null, 2);

        currentEl = el;
    }

    // 접근방식 편집 토글
    function toggleApproachEdit() {
        document.getElementById("approach-view").classList.add("hidden");
        document.getElementById("approach-edit").classList.remove("hidden");
        document.getElementById("approach-edit-btn").classList.add("hidden");
    }
    function cancelApproachEdit() {
        document.getElementById("approach-view").classList.remove("hidden");
        document.getElementById("approach-edit").classList.add("hidden");
        document.getElementById("approach-edit-btn").classList.remove("hidden");
    }

    // 접근방식 저장(PATCH)
    async function saveApproach() {
        const newApproach = document
            .getElementById("approach-input")
            .value.trim();
        const item = JSON.parse(
            document.getElementById("item-data").textContent,
        );

        const res = await fetch(`/api/posts/${item.id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ approach: newApproach }),
        });

        if (res.ok) {
            document.getElementById("approach-view").textContent = newApproach;
            cancelApproachEdit();
            alert("업데이트 성공");
        } else {
            alert("업데이트 실패");
        }
    }
</script>
{% endblock %}
